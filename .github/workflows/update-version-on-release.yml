name: Update Version on Release

on:
  release:
    types: [published]

jobs:
  update-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        ref: main

    - name: Extract version from release tag
      id: get_version
      run: |
        # Remove 'v' prefix if it exists (e.g., v2.1.0 -> 2.1.0)
        VERSION=${GITHUB_REF#refs/tags/}
        VERSION=${VERSION#v}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Extracted version: ${VERSION}"

    - name: Update version in install.sh
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        echo "Updating installer_version in install.sh to ${VERSION}"
        
        # Update the installer_version in install.sh
        sed -i "s/\"installer_version\": \"[^\"]*\"/\"installer_version\": \"${VERSION}\"/g" install.sh
        
        # Verify the change
        echo "Updated content in install.sh:"
        grep -n "installer_version" install.sh

    - name: Update version in wakaterm.py
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        echo "Updating plugin version in wakaterm.py to ${VERSION}"
        
        # bump the plugin version in wakaterm.py
        sed -i "s/\"plugin\": \"wakaterm-ng\/[^\"]*\"/\"plugin\": \"wakaterm-ng\/${VERSION}\"/g" wakaterm.py
        
        # Verify the change
        echo "Updated content in wakaterm.py:"
        grep -n "plugin.*wakaterm-ng" wakaterm.py

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet; then
          echo "No changes to commit"
        else
          git add install.sh wakaterm.py
          git commit -m "chore: update version to ${{ steps.get_version.outputs.version }}"
          git push origin main
          echo "Version updated and pushed to repository"
        fi